!function(e){"use strict";const t="1.3.0",n="https://www.liaplus.com/api";class i{constructor(){this.cache={headings:null,landmarks:null,links:null,forms:null,lastParsed:0},this.cacheTimeout=5e3}parse(e=!1){const t=Date.now();return!e&&this.cache.lastParsed&&t-this.cache.lastParsed<this.cacheTimeout||(this.cache={headings:this.extractHeadings(),landmarks:this.extractLandmarks(),links:this.extractLinks(),forms:this.extractForms(),lastParsed:t}),this.cache}extractHeadings(){const e=[];return document.querySelectorAll("h1, h2, h3, h4, h5, h6").forEach((t,n)=>{const i=t.textContent.trim();i&&e.push({level:parseInt(t.tagName[1]),text:i,id:t.id||null,element:t,index:n})}),e}extractLandmarks(){const e=[];["banner","navigation","main","complementary","contentinfo","search","form"].forEach(t=>{document.querySelectorAll(`[role="${t}"]`).forEach(n=>{e.push({role:t,label:n.getAttribute("aria-label")||n.getAttribute("aria-labelledby")||null,element:n})})});return Object.entries({header:"banner",nav:"navigation",main:"main",aside:"complementary",footer:"contentinfo"}).forEach(([t,n])=>{document.querySelectorAll(t).forEach(t=>{t.hasAttribute("role")||e.push({role:n,label:t.getAttribute("aria-label")||null,element:t})})}),e}extractLinks(){const e=[];return document.querySelectorAll("a[href]").forEach((t,n)=>{const i=t.textContent.trim(),s=t.href;i&&s&&!s.startsWith("javascript:")&&e.push({text:i,href:s,element:t,index:n})}),e}extractForms(){const e=[];return document.querySelectorAll("form").forEach((t,n)=>{const i=[];t.querySelectorAll("input, select, textarea").forEach(e=>{const t=this.getFieldLabel(e),n=e.type||e.tagName.toLowerCase();i.push({type:n,name:e.name||e.id||null,label:t,required:e.hasAttribute("required"),element:e})}),e.push({id:t.id||`form-${n}`,action:t.action||null,method:t.method||"get",fields:i,element:t})}),e}getFieldLabel(e){if(e.id){const t=document.querySelector(`label[for="${e.id}"]`);if(t)return t.textContent.trim()}const t=e.closest("label");if(t)return t.textContent.trim();if(e.hasAttribute("aria-label"))return e.getAttribute("aria-label");if(e.hasAttribute("aria-labelledby")){const t=e.getAttribute("aria-labelledby"),n=document.getElementById(t);if(n)return n.textContent.trim()}return e.placeholder?e.placeholder:e.name||"Unlabeled field"}getMainContent(){const e=[()=>document.querySelector("main"),()=>document.querySelector('[role="main"]'),()=>document.querySelector("#main"),()=>document.querySelector("#content"),()=>document.querySelector(".main-content"),()=>document.querySelector("article"),()=>{const e=document.body.cloneNode(!0);return e.querySelectorAll('nav, header, footer, aside, [role="navigation"], [role="banner"], [role="contentinfo"]').forEach(e=>e.remove()),e}];for(const t of e){const e=t();if(e)return e}return document.body}getPageContent(){return this.getMainContent().textContent.replace(/\s+/g," ").trim().slice(0,4e3)}}class s{constructor(e,t="en-US"){this.synthesizer=e,this.language=t,this.isReading=!1,this.isPaused=!1,this.isSpeaking=!1,this.speed=1,this.currentPosition=0,this.content=[],this.currentIndex=0,this.voiceStyle="friendly"}setLanguage(e){this.language=e}setSpeed(e){this.speed=Math.max(.5,Math.min(2,e))}interruptSpeech(){this.isSpeaking&&this.synthesizer&&this.synthesizer.stopSpeakingAsync(()=>{this.isSpeaking=!1},()=>{this.isSpeaking=!1})}async readPage(){const e=(new i).getMainContent();this.content=this.extractReadableContent(e),this.currentIndex=0,this.isReading=!0,this.isPaused=!1,await this.readContinuous()}async readNext(){this.currentIndex<this.content.length-1&&(this.currentIndex++,await this.speak(this.content[this.currentIndex]))}async readPrevious(){this.currentIndex>0&&(this.currentIndex--,await this.speak(this.content[this.currentIndex]))}extractReadableContent(e){const t=[],n=document.createTreeWalker(e,NodeFilter.SHOW_ELEMENT,{acceptNode:e=>{const t=e.tagName.toLowerCase();return["p","h1","h2","h3","h4","h5","h6","li","blockquote","div","section","article"].includes(t)?NodeFilter.FILTER_ACCEPT:NodeFilter.FILTER_SKIP}});let i;for(;i=n.nextNode();){const e=i.textContent.trim();if(e.length>20){let n="";const s=i.tagName.toLowerCase();if(s.startsWith("h")){n=`Heading level ${s[1]}. `}t.push(n+e)}}return t.length>0?t:[e.textContent.trim()]}async readContinuous(){for(;this.isReading&&this.currentIndex<this.content.length;)this.isPaused?await new Promise(e=>setTimeout(e,100)):(await this.speak(this.content[this.currentIndex]),this.currentIndex++);this.currentIndex>=this.content.length&&(this.isReading=!1,await this.speak("hi-IN"===this.language?"à¤ªà¥‡à¤œ à¤ªà¥‚à¤°à¤¾ à¤¹à¥‹ à¤—à¤¯à¤¾":"End of page"))}pause(){this.isPaused=!0,this.interruptSpeech()}resume(){this.isPaused=!1}stop(){this.isReading=!1,this.isPaused=!1,this.currentIndex=0,this.interruptSpeech()}async speak(e,t={}){return new Promise(n=>{if(!this.synthesizer||!e)return void n();this.isSpeaking=!0;const i=this.buildSSML(e,t);this.synthesizer.speakSsmlAsync(i,()=>{this.isSpeaking=!1,n()},e=>{this.isSpeaking=!1,console.error("[LiaPlus] Speech error:",e),n()})})}buildSSML(e,t={}){const{emphasis:n,pause:i,style:s}=t,a=this.getVoiceName();let o=`<speak version="1.0" xmlns="http://www.w3.org/2001/10/synthesis" xmlns:mstts="https://www.w3.org/2001/mstts" xml:lang="${this.language}">`;return o+=`<voice name="${a}">`,"friendly"===this.voiceStyle&&a.includes("Neural")&&(o+='<mstts:express-as style="chat">'),o+=`<prosody rate="${this.speed}">`,i&&(o+=`<break time="${i}ms"/>`),o+=this.escapeXml(e),o+="</prosody>","friendly"===this.voiceStyle&&a.includes("Neural")&&(o+="</mstts:express-as>"),o+="</voice></speak>",o}getVoiceName(){const e={"en-US":"en-US-AriaNeural","en-IN":"en-IN-NeerjaNeural","hi-IN":"hi-IN-SwaraNeural"};return e[this.language]||e["en-US"]}escapeXml(e){return e.replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/"/g,"&quot;").replace(/'/g,"&apos;")}async announceElement(e){const t=e.tagName.toLowerCase(),n=e.textContent.trim();let s="";if(t.startsWith("h")){s=`Heading level ${t[1]}. ${n}`}else if("a"===t)s=`Link. ${n}`;else if("button"===t)s=`Button. ${n}`;else if("input"===t){s=`${e.type} field. ${(new i).getFieldLabel(e)}`}else s=n;await this.speak(s)}}class a{constructor(e,t,n={}){this.reader=e,this.parser=t,this.options=n,this.currentHeadingIndex=-1,this.currentLinkIndex=-1}async execute(t,n={}){console.log("[LiaPlus] Executing action:",t,"with parameters:",n);const i={read_page:()=>this.reader.readPage(),read_next:()=>this.reader.readNext(),read_previous:()=>this.reader.readPrevious(),stop_reading:()=>this.reader.stop(),read_faster:()=>(this.reader.setSpeed(this.reader.speed+.25),this.reader.speak("hi-IN"===this.reader.language?"à¤¤à¥‡à¤œà¤¼":"Faster")),read_slower:()=>(this.reader.setSpeed(this.reader.speed-.25),this.reader.speak("hi-IN"===this.reader.language?"à¤§à¥€à¤°à¥‡":"Slower")),list_headings:()=>this.listHeadings(),next_heading:()=>this.navigateHeadings(1),previous_heading:()=>this.navigateHeadings(-1),list_links:()=>this.listLinks(),next_link:()=>this.navigateLinks(1),previous_link:()=>this.navigateLinks(-1),list_landmarks:()=>this.listLandmarks(),go_to_heading:()=>this.goToHeading(n.text),click_link:()=>this.clickLink(n.text),search_page:()=>this.searchPage(n.text),describe_page:()=>this.describePage(),scroll_down:()=>e.scrollBy({top:400,behavior:"smooth"}),scroll_up:()=>e.scrollBy({top:-400,behavior:"smooth"}),scroll_to_top:()=>e.scrollTo({top:0,behavior:"smooth"}),scroll_to_bottom:()=>e.scrollTo({top:document.documentElement.scrollHeight,behavior:"smooth"}),tab:()=>this.simulateTab(),enter:()=>this.simulateEnter(),back:()=>e.history.back(),list_forms:()=>this.listForms(),fill_form:()=>this.fillForm(n),fill_field:()=>this.fillField(n),submit_form:()=>this.submitForm(),navigate:()=>{n.url&&(e.location.href=n.url)},where_am_i:()=>this.announceLocation(),show_commands:()=>this.showCommandsPanel()}[t];return!!i&&await i()}async goToHeading(e){if(!e)return void await this.reader.speak("hi-IN"===this.reader.language?"à¤•à¥‹à¤ˆ heading à¤¨à¤¹à¥€à¤‚ à¤¬à¤¤à¤¾à¤ˆ":"No heading specified");const t=this.parser.parse().headings,n=e.toLowerCase().trim(),i=t.find(e=>e.text.toLowerCase().includes(n)||n.includes(e.text.toLowerCase()));if(i){i.element.scrollIntoView({behavior:"smooth",block:"center"}),i.element.focus();const e="hi-IN"===this.reader.language?`${i.text} section à¤ªà¤° à¤† à¤—à¤`:`Navigated to ${i.text}`;await this.reader.speak(e),await new Promise(e=>setTimeout(e,500));const t=this.getHeadingContent(i.element);t&&await this.reader.speak(t)}else await this.reader.speak("hi-IN"===this.reader.language?`${e} à¤¨à¤¹à¥€à¤‚ à¤®à¤¿à¤²à¤¾`:`Could not find ${e}`)}async clickLink(e){if(!e)return void await this.reader.speak("hi-IN"===this.reader.language?"à¤•à¥‹à¤ˆ link à¤¨à¤¹à¥€à¤‚ à¤¬à¤¤à¤¾à¤¯à¤¾":"No link specified");const t=this.parser.parse().links,n=e.toLowerCase().trim(),i=t.find(e=>e.text.toLowerCase().includes(n)||n.includes(e.text.toLowerCase()));if(i){const e="hi-IN"===this.reader.language?`${i.text} link à¤•à¥‹ click à¤•à¤° à¤°à¤¹à¥‡ à¤¹à¥ˆà¤‚`:`Clicking ${i.text} link`;await this.reader.speak(e),await new Promise(e=>setTimeout(e,300)),i.element.click()}else await this.reader.speak("hi-IN"===this.reader.language?`${e} link à¤¨à¤¹à¥€à¤‚ à¤®à¤¿à¤²à¤¾`:`Could not find ${e} link`)}async searchPage(t){if(!t)return void await this.reader.speak("hi-IN"===this.reader.language?"à¤•à¥à¤¯à¤¾ à¤–à¥‹à¤œà¤¨à¤¾ à¤¹à¥ˆ?":"What do you want to search?");const n=document.body.textContent.toLowerCase(),i=t.toLowerCase();n.includes(i)?e.find?(e.find(t),await this.reader.speak("hi-IN"===this.reader.language?`${t} à¤®à¤¿à¤² à¤—à¤¯à¤¾`:`Found ${t}`)):(this.highlightText(t),await this.reader.speak("hi-IN"===this.reader.language?`${t} à¤•à¥‹ highlight à¤•à¤¿à¤¯à¤¾`:`Highlighted ${t}`)):await this.reader.speak("hi-IN"===this.reader.language?`${t} à¤¨à¤¹à¥€à¤‚ à¤®à¤¿à¤²à¤¾`:`Could not find ${t}`)}async describePage(){const t=this.parser.parse(),n=document.title;e.location.href;let i="hi-IN"===this.reader.language?`à¤¯à¤¹ ${n} à¤ªà¥‡à¤œ à¤¹à¥ˆà¥¤ `:`This is ${n}. `;if(t.headings.length>0){const e=t.headings.filter(e=>e.level<=2);i+="hi-IN"===this.reader.language?`à¤‡à¤¸à¤®à¥‡à¤‚ ${e.length} à¤®à¥à¤–à¥à¤¯ sections à¤¹à¥ˆà¤‚: ${e.slice(0,5).map(e=>e.text).join(", ")}à¥¤ `:`It has ${e.length} main sections: ${e.slice(0,5).map(e=>e.text).join(", ")}. `}t.links.length>0&&(i+="hi-IN"===this.reader.language?`${t.links.length} links à¤¹à¥ˆà¤‚à¥¤ `:`There are ${t.links.length} links. `),t.forms.length>0&&(i+="hi-IN"===this.reader.language?`${t.forms.length} forms à¤¹à¥ˆà¤‚à¥¤ `:`There are ${t.forms.length} forms. `),await this.reader.speak(i)}getHeadingContent(e){const t=parseInt(e.tagName[1]);let n=e.nextElementSibling,i="";for(;n;){const e=n.tagName.toLowerCase();if(e.startsWith("h")){if(parseInt(e[1])<=t)break}const s=n.textContent.trim();if(s&&s.length>20&&(i+=s+" ",i.length>500))break;n=n.nextElementSibling}return i.trim().slice(0,500)}highlightText(t){const n=e.getSelection(),i=document.createRange(),s=document.createTreeWalker(document.body,NodeFilter.SHOW_TEXT,null);let a;for(;a=s.nextNode();){const e=a.textContent.toLowerCase().indexOf(t.toLowerCase());if(e>=0){i.setStart(a,e),i.setEnd(a,e+t.length),n.removeAllRanges(),n.addRange(i);const s=a.parentElement;s&&s.scrollIntoView({behavior:"smooth",block:"center"});break}}}async listHeadings(){const e=this.parser.parse().headings;if(0===e.length)return void await this.reader.speak("hi-IN"===this.reader.language?"à¤•à¥‹à¤ˆ à¤¹à¥‡à¤¡à¤¿à¤‚à¤— à¤¨à¤¹à¥€à¤‚ à¤®à¤¿à¤²à¥€":"No headings found");let t="hi-IN"===this.reader.language?`${e.length} à¤¹à¥‡à¤¡à¤¿à¤‚à¤— à¤®à¤¿à¤²à¥€à¥¤ `:`Found ${e.length} headings. `;e.slice(0,5).forEach((e,n)=>{t+=`${n+1}. Level ${e.level}, ${e.text}. `}),e.length>5&&(t+="hi-IN"===this.reader.language?"à¤”à¤° à¤­à¥€ à¤¹à¥ˆà¤‚à¥¤":"And more."),await this.reader.speak(t)}async navigateHeadings(e){const t=this.parser.parse().headings;if(0===t.length)return void await this.reader.speak("hi-IN"===this.reader.language?"à¤•à¥‹à¤ˆ à¤¹à¥‡à¤¡à¤¿à¤‚à¤— à¤¨à¤¹à¥€à¤‚":"No headings");this.currentHeadingIndex+=e,this.currentHeadingIndex<0?this.currentHeadingIndex=0:this.currentHeadingIndex>=t.length&&(this.currentHeadingIndex=t.length-1);const n=t[this.currentHeadingIndex];n.element.scrollIntoView({behavior:"smooth",block:"center"}),n.element.focus(),await this.reader.announceElement(n.element)}async listLinks(){const e=this.parser.parse().links;if(0===e.length)return void await this.reader.speak("hi-IN"===this.reader.language?"à¤•à¥‹à¤ˆ à¤²à¤¿à¤‚à¤• à¤¨à¤¹à¥€à¤‚ à¤®à¤¿à¤²à¥€":"No links found");let t="hi-IN"===this.reader.language?`${e.length} à¤²à¤¿à¤‚à¤• à¤®à¤¿à¤²à¥€à¥¤ `:`Found ${e.length} links. `;e.slice(0,5).forEach((e,n)=>{t+=`${n+1}. ${e.text}. `}),e.length>5&&(t+="hi-IN"===this.reader.language?"à¤”à¤° à¤­à¥€ à¤¹à¥ˆà¤‚à¥¤":"And more."),await this.reader.speak(t)}async navigateLinks(e){const t=this.parser.parse().links;if(0===t.length)return void await this.reader.speak("hi-IN"===this.reader.language?"à¤•à¥‹à¤ˆ à¤²à¤¿à¤‚à¤• à¤¨à¤¹à¥€à¤‚":"No links");this.currentLinkIndex+=e,this.currentLinkIndex<0?this.currentLinkIndex=0:this.currentLinkIndex>=t.length&&(this.currentLinkIndex=t.length-1);const n=t[this.currentLinkIndex];n.element.scrollIntoView({behavior:"smooth",block:"center"}),n.element.focus(),await this.reader.announceElement(n.element)}async listLandmarks(){const e=this.parser.parse().landmarks;if(0===e.length)return void await this.reader.speak("hi-IN"===this.reader.language?"à¤•à¥‹à¤ˆ landmark à¤¨à¤¹à¥€à¤‚ à¤®à¤¿à¤²à¤¾":"No landmarks found");let t="hi-IN"===this.reader.language?`${e.length} landmark à¤®à¤¿à¤²à¥‡à¥¤ `:`Found ${e.length} landmarks. `;e.forEach((e,n)=>{const i=e.label||e.role;t+=`${n+1}. ${i}. `}),await this.reader.speak(t)}simulateTab(){const e=document.querySelectorAll('a[href], button, input, select, textarea, [tabindex]:not([tabindex="-1"])'),t=document.activeElement,n=Array.from(e).indexOf(t);n<e.length-1&&(e[n+1].focus(),this.reader.announceElement(e[n+1]))}simulateEnter(){const e=document.activeElement;!e||"A"!==e.tagName&&"BUTTON"!==e.tagName||e.click()}async announceLocation(){const t=e.location.href,n=`${document.title}. URL: ${t}`;await this.reader.speak(n)}showCommandsPanel(){const t=new CustomEvent("liaplus:show-commands");e.dispatchEvent(t)}async listForms(){const e=this.parser.parse().forms;if(0===e.length)return void await this.reader.speak("hi-IN"===this.reader.language?"à¤•à¥‹à¤ˆ form à¤¨à¤¹à¥€à¤‚ à¤®à¤¿à¤²à¤¾":"No forms found on this page");let t="hi-IN"===this.reader.language?`${e.length} form à¤®à¤¿à¤²à¥‡à¥¤ `:`Found ${e.length} forms. `;e.forEach((e,n)=>{const i=e.fields.length;t+=`Form ${n+1} has ${i} fields. `}),await this.reader.speak(t)}async fillForm(e){console.log("[LiaPlus] fillForm called with parameters:",e);const t=e.data||{};console.log("[LiaPlus] Form data to fill:",t);const n=this.parser.parse().forms;if(console.log("[LiaPlus] Found forms:",n.length),0===n.length)return void await this.reader.speak("hi-IN"===this.reader.language?"à¤•à¥‹à¤ˆ form à¤¨à¤¹à¥€à¤‚ à¤®à¤¿à¤²à¤¾":"No forms found");let i=n[0];e.formId&&(i=n.find(t=>t.id===e.formId)||n[0]),console.log("[LiaPlus] Target form:",i.id,"with",i.fields.length,"fields");let s=0;for(const e of i.fields){console.log("[LiaPlus] Attempting to fill field:",e.name,e.label,e.type);await this.fillFieldByType(e,t)?(s++,console.log("[LiaPlus] Successfully filled:",e.name)):console.log("[LiaPlus] Could not fill:",e.name,"- no matching data")}const a="hi-IN"===this.reader.language?`${s} fields à¤­à¤° à¤¦à¤¿à¤ à¤—à¤`:`Filled ${s} fields successfully`;console.log("[LiaPlus] Form filling complete:",s,"fields filled"),await this.reader.speak(a)}async fillField(e){const{fieldName:t,value:n}=e;if(!t||!n)return void await this.reader.speak("Please specify field name and value");const i=document.querySelector(`input[name="${t}"], input[id="${t}"], textarea[name="${t}"], textarea[id="${t}"], select[name="${t}"], select[id="${t}"]`);if(i){if("select"===i.tagName.toLowerCase()){const e=Array.from(i.options).find(e=>e.value.toLowerCase().includes(n.toLowerCase())||e.text.toLowerCase().includes(n.toLowerCase()));e&&(i.value=e.value,i.dispatchEvent(new Event("change",{bubbles:!0})))}else"checkbox"===i.type||"radio"===i.type?(i.checked=["true","yes","1","on"].includes(n.toLowerCase()),i.dispatchEvent(new Event("change",{bubbles:!0}))):(i.value=n,i.dispatchEvent(new Event("input",{bubbles:!0})),i.dispatchEvent(new Event("change",{bubbles:!0})));await this.reader.speak(`Filled ${t} with ${n}`)}else await this.reader.speak(`Could not find field: ${t}`)}async fillFieldByType(e,t){const n=e.type.toLowerCase(),i=e.name||e.label.toLowerCase(),s=e.element;let a=null;if(t[i]?a=t[i]:n.includes("email")||i.includes("email")?a=t.email||t.emailAddress:n.includes("tel")||i.includes("phone")||i.includes("mobile")?a=t.phone||t.mobile||t.telephone:i.includes("first")&&i.includes("name")?a=t.firstName||t.first_name:i.includes("last")&&i.includes("name")?a=t.lastName||t.last_name:i.includes("name")&&!i.includes("user")?a=t.name||t.fullName:i.includes("address")||i.includes("street")?a=t.address||t.street:i.includes("city")?a=t.city:i.includes("state")||i.includes("province")?a=t.state||t.province:i.includes("zip")||i.includes("postal")?a=t.zip||t.zipCode||t.postalCode:i.includes("country")?a=t.country:i.includes("company")||i.includes("organization")?a=t.company||t.organization:(i.includes("message")||i.includes("comment"))&&(a=t.message||t.comments),!a)return!1;if("select"===s.tagName.toLowerCase()){const e=Array.from(s.options).find(e=>e.value.toLowerCase().includes(a.toLowerCase())||e.text.toLowerCase().includes(a.toLowerCase()));if(e)return s.value=e.value,s.dispatchEvent(new Event("change",{bubbles:!0})),!0}else{if("checkbox"===s.type)return s.checked=["true","yes","1","on"].includes(String(a).toLowerCase()),s.dispatchEvent(new Event("change",{bubbles:!0})),!0;if("radio"!==s.type)return s.value=a,s.dispatchEvent(new Event("input",{bubbles:!0})),s.dispatchEvent(new Event("change",{bubbles:!0})),!0;if(s.value.toLowerCase()===String(a).toLowerCase())return s.checked=!0,s.dispatchEvent(new Event("change",{bubbles:!0})),!0}return!1}async submitForm(){const e=this.parser.parse().forms;if(0===e.length)return void await this.reader.speak("No forms found");const t=e[0].element;await this.reader.speak("hi-IN"===this.reader.language?"Form submit à¤•à¤° à¤°à¤¹à¥‡ à¤¹à¥ˆà¤‚":"Submitting form"),t.submit()}}class o{constructor(e={}){this.options={apiKey:e.apiKey||null,language:e.language||"en-US",position:e.position||"bottom-right",theme:e.theme||"auto",routes:e.routes||{},customCommands:e.customCommands||{},onCommand:e.onCommand||null,onError:e.onError||null,offline:!1!==e.offline,...e},this.isInitialized=!1,this.isListening=!1,this.recognizer=null,this.synthesizer=null,this.parser=new i,this.reader=null,this.executor=null,this.conversationHistory=[],this.lastAction=null,this.lastParameters={},this.lastContext=null,this.lastScrollAmount=400,this.uiState={status:"idle",transcript:"",response:"",action:null,confidence:0}}async init(){if(this.isInitialized)console.warn("[LiaPlus] Plugin already initialized");else try{return await this.initAzureSpeech(),this.reader=new s(this.synthesizer,this.options.language),this.executor=new a(this.reader,this.parser,this.options),this.createUI(),this.isInitialized=!0,console.log("[LiaPlus] Voice Navigation Plugin initialized",t),this.loadState(),!0}catch(e){return console.error("[LiaPlus] Initialization failed:",e),this.options.onError&&this.options.onError(e),!1}}async initAzureSpeech(){if("undefined"==typeof SpeechSDK)throw new Error("Microsoft Speech SDK not loaded");try{const e=await fetch(`${n}/azure-speech`);if(!e.ok)throw new Error("Failed to get Azure Speech credentials");const{token:t,region:i}=await e.json(),s=SpeechSDK.SpeechConfig.fromSubscription(t,i);s.speechRecognitionLanguage=this.options.language;const a=SpeechSDK.AudioConfig.fromDefaultMicrophoneInput();this.recognizer=new SpeechSDK.SpeechRecognizer(s,a);const o=SpeechSDK.SpeechConfig.fromSubscription(t,i);o.speechSynthesisLanguage=this.options.language,o.speechSynthesisVoiceName="hi-IN"===this.options.language?"hi-IN-SwaraNeural":"en-US-JennyNeural";const r=SpeechSDK.AudioConfig.fromDefaultSpeakerOutput();return this.synthesizer=new SpeechSDK.SpeechSynthesizer(o,r),!0}catch(e){throw console.error("[LiaPlus] Azure Speech init failed:",e),e}}createUI(){const e=document.getElementById("liaplus-voice-ui");e&&e.remove();const t=document.createElement("div");t.id="liaplus-voice-ui";const n=this.options.position||"bottom-right",i={"bottom-right":"bottom: 24px; right: 24px;","bottom-left":"bottom: 24px; left: 24px;","top-right":"top: 24px; right: 24px;","top-left":"top: 24px; left: 24px;"};t.innerHTML=`\n        <style>\n          /* Base styles */\n          #liaplus-voice-ui {\n            position: fixed;\n            ${i[n]||i["bottom-right"]}\n            z-index: 999999;\n            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;\n          }\n          \n          /* Pill Button (Idle State) */\n          #liaplus-pill-btn {\n            display: flex;\n            align-items: center;\n            gap: 8px;\n            padding: 10px 20px;\n            border-radius: 9999px;\n            background: white;\n            border: 1px solid #e5e7eb;\n            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.08);\n            cursor: pointer;\n            font-size: 14px;\n            font-weight: 500;\n            color: #374151;\n            transition: all 0.2s ease;\n          }\n          \n          #liaplus-pill-btn:hover {\n            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.12);\n            transform: translateY(-1px);\n          }\n          \n          #liaplus-pill-btn svg {\n            width: 18px;\n            height: 18px;\n            fill: currentColor;\n          }\n          \n          #liaplus-pill-btn.hidden {\n            display: none;\n          }\n          \n          /* Overlay (Active State) */\n          #liaplus-overlay {\n            position: absolute;\n            bottom: 60px;\n            right: 0;\n            width: 320px;\n            background: white;\n            border: 1px solid #e5e7eb;\n            border-radius: 16px;\n            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.12);\n            display: none;\n            overflow: hidden;\n            animation: liaplus-slideUp 0.3s ease;\n          }\n          \n          #liaplus-overlay.open {\n            display: block;\n          }\n          \n          @keyframes liaplus-slideUp {\n            from { \n              opacity: 0; \n              transform: translateY(10px) scale(0.95); \n            }\n            to { \n              opacity: 1; \n              transform: translateY(0) scale(1); \n            }\n          }\n          \n          /* Header */\n          #liaplus-overlay-header {\n            display: flex;\n            align-items: center;\n            justify-content: space-between;\n            padding: 16px;\n            border-bottom: 1px solid #f3f4f6;\n          }\n          \n          .liaplus-status-wrapper {\n            display: flex;\n            align-items: center;\n            gap: 8px;\n          }\n          \n          .liaplus-status-indicator {\n            width: 10px;\n            height: 10px;\n            border-radius: 50%;\n            background: #d1d5db;\n          }\n          \n          .liaplus-status-indicator.listening {\n            background: #10b981;\n            animation: liaplus-pulse 1.5s infinite;\n          }\n          \n          .liaplus-status-indicator.processing {\n            background: #f59e0b;\n            animation: liaplus-spin 1s linear infinite;\n          }\n          \n          .liaplus-status-indicator.completed {\n            background: #10b981;\n          }\n          \n          @keyframes liaplus-pulse {\n            0%, 100% { \n              box-shadow: 0 0 0 0 rgba(16, 185, 129, 0.4); \n              opacity: 1;\n            }\n            50% { \n              box-shadow: 0 0 0 8px rgba(16, 185, 129, 0); \n              opacity: 0.7;\n            }\n          }\n          \n          @keyframes liaplus-spin {\n            from { transform: rotate(0deg); }\n            to { transform: rotate(360deg); }\n          }\n          \n          .liaplus-status-text {\n            font-size: 14px;\n            font-weight: 500;\n            color: #111827;\n          }\n          \n          #liaplus-close-btn {\n            padding: 4px;\n            border: none;\n            background: transparent;\n            color: #9ca3af;\n            cursor: pointer;\n            border-radius: 4px;\n            transition: all 0.2s;\n          }\n          \n          #liaplus-close-btn:hover {\n            background: #f3f4f6;\n            color: #374151;\n          }\n          \n          #liaplus-close-btn svg {\n            width: 20px;\n            height: 20px;\n            stroke: currentColor;\n          }\n          \n          /* Body sections */\n          #liaplus-overlay-body {\n            padding: 16px;\n          }\n          \n          .liaplus-section {\n            margin-bottom: 12px;\n          }\n          \n          .liaplus-section:last-child {\n            margin-bottom: 0;\n          }\n          \n          .liaplus-section-label {\n            font-size: 11px;\n            font-weight: 600;\n            text-transform: uppercase;\n            letter-spacing: 0.5px;\n            color: #6b7280;\n            margin-bottom: 6px;\n          }\n          \n          .liaplus-section-content {\n            font-size: 14px;\n            line-height: 1.5;\n            color: #374151;\n          }\n          \n          /* Transcript */\n          #liaplus-transcript-section {\n            background: #f9fafb;\n            border-radius: 8px;\n            padding: 12px;\n            min-height: 60px;\n          }\n          \n          #liaplus-transcript-text {\n            font-style: italic;\n            color: #6b7280;\n          }\n          \n          #liaplus-transcript-text.active {\n            color: #111827;\n          }\n          \n          /* Response */\n          #liaplus-response-section {\n            background: #eff6ff;\n            border-left: 3px solid #3b82f6;\n            border-radius: 8px;\n            padding: 12px;\n            display: none;\n          }\n          \n          #liaplus-response-section.show {\n            display: block;\n          }\n          \n          #liaplus-response-text {\n            color: #1e40af;\n          }\n          \n          /* Action badge */\n          #liaplus-action-section {\n            display: none;\n            align-items: center;\n            gap: 8px;\n          }\n          \n          #liaplus-action-section.show {\n            display: flex;\n          }\n          \n          .liaplus-action-badge {\n            display: inline-flex;\n            align-items: center;\n            gap: 6px;\n            padding: 6px 12px;\n            background: #f3f4f6;\n            border-radius: 9999px;\n            font-size: 12px;\n            font-weight: 500;\n            color: #374151;\n          }\n          \n          .liaplus-action-icon {\n            width: 14px;\n            height: 14px;\n          }\n          \n          .liaplus-action-status {\n            margin-left: auto;\n          }\n          \n          .liaplus-action-status svg {\n            width: 16px;\n            height: 16px;\n            stroke: #10b981;\n          }\n          \n          /* Progress bar */\n          .liaplus-progress-bar {\n            height: 2px;\n            background: #f3f4f6;\n            overflow: hidden;\n            display: none;\n          }\n          \n          .liaplus-progress-bar.show {\n            display: block;\n          }\n          \n          .liaplus-progress-fill {\n            height: 100%;\n            background: #3b82f6;\n            animation: liaplus-progress 1.5s ease-in-out infinite;\n          }\n          \n          @keyframes liaplus-progress {\n            0% {\n              width: 0%;\n              margin-left: 0%;\n            }\n            50% {\n              width: 50%;\n              margin-left: 25%;\n            }\n            100% {\n              width: 0%;\n              margin-left: 100%;\n            }\n          }\n          \n          /* Dark mode support */\n          @media (prefers-color-scheme: dark) {\n            #liaplus-pill-btn {\n              background: #18181b;\n              border-color: #27272a;\n              color: #f4f4f5;\n            }\n            \n            #liaplus-overlay {\n              background: #18181b;\n              border-color: #27272a;\n            }\n            \n            #liaplus-overlay-header {\n              border-bottom-color: #27272a;\n            }\n            \n            .liaplus-status-text {\n              color: #f4f4f5;\n            }\n            \n            #liaplus-close-btn {\n              color: #71717a;\n            }\n            \n            #liaplus-close-btn:hover {\n              background: #27272a;\n              color: #a1a1aa;\n            }\n            \n            #liaplus-transcript-section {\n              background: #27272a;\n            }\n            \n            #liaplus-transcript-text {\n              color: #a1a1aa;\n            }\n            \n            #liaplus-transcript-text.active {\n              color: #f4f4f5;\n            }\n            \n            #liaplus-response-section {\n              background: #1e293b;\n              border-left-color: #3b82f6;\n            }\n            \n            #liaplus-response-text {\n              color: #93c5fd;\n            }\n            \n            .liaplus-action-badge {\n              background: #27272a;\n              color: #f4f4f5;\n            }\n            \n            .liaplus-section-label {\n              color: #a1a1aa;\n            }\n            \n            .liaplus-section-content {\n              color: #e4e4e7;\n            }\n            \n            .liaplus-progress-bar {\n              background: #27272a;\n            }\n          }\n        </style>\n        \n        \x3c!-- Pill Button (Idle) --\x3e\n        <button id="liaplus-pill-btn" aria-label="Start voice command">\n          <svg viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">\n            <path d="M12 2a3 3 0 0 0-3 3v7a3 3 0 0 0 6 0V5a3 3 0 0 0-3-3Z" fill="currentColor"/>\n            <path d="M19 10v2a7 7 0 0 1-14 0v-2M12 19v3" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>\n          </svg>\n          <span>Voice</span>\n        </button>\n        \n        \x3c!-- Overlay (Active) --\x3e\n        <div id="liaplus-overlay" role="dialog" aria-label="Voice command overlay">\n          \x3c!-- Header --\x3e\n          <div id="liaplus-overlay-header">\n            <div class="liaplus-status-wrapper">\n              <span class="liaplus-status-indicator" id="liaplus-status-indicator"></span>\n              <span class="liaplus-status-text" id="liaplus-status-text">Idle</span>\n            </div>\n            <button id="liaplus-close-btn" aria-label="Close overlay">\n              <svg viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">\n                <path d="M18 6L6 18M6 6l12 12" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>\n              </svg>\n            </button>\n          </div>\n          \n          \x3c!-- Body --\x3e\n          <div id="liaplus-overlay-body">\n            \x3c!-- Transcript --\x3e\n            <div class="liaplus-section" id="liaplus-transcript-section">\n              <div class="liaplus-section-label">You</div>\n              <div class="liaplus-section-content" id="liaplus-transcript-text">\n                Say a command like "Read page" or "Scroll down"\n              </div>\n            </div>\n            \n            \x3c!-- Response --\x3e\n            <div class="liaplus-section" id="liaplus-response-section">\n              <div class="liaplus-section-label">Lia</div>\n              <div class="liaplus-section-content" id="liaplus-response-text"></div>\n            </div>\n            \n            \x3c!-- Action --\x3e\n            <div class="liaplus-section" id="liaplus-action-section">\n              <div class="liaplus-action-badge">\n                <svg class="liaplus-action-icon" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">\n                  <path d="M13 10V3L4 14h7v7l9-11h-7z" fill="currentColor"/>\n                </svg>\n                <span id="liaplus-action-text">Action</span>\n              </div>\n              <span class="liaplus-action-status">\n                <svg viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">\n                  <path d="M20 6L9 17l-5-5" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>\n                </svg>\n              </span>\n            </div>\n          </div>\n          \n          \x3c!-- Progress Bar --\x3e\n          <div class="liaplus-progress-bar" id="liaplus-progress-bar">\n            <div class="liaplus-progress-fill"></div>\n          </div>\n        </div>\n      `,document.body.appendChild(t);const s=document.getElementById("liaplus-pill-btn"),a=document.getElementById("liaplus-overlay"),o=document.getElementById("liaplus-close-btn"),r=document.getElementById("liaplus-status-indicator"),l=document.getElementById("liaplus-status-text"),c=document.getElementById("liaplus-transcript-text"),d=document.getElementById("liaplus-response-section"),h=document.getElementById("liaplus-response-text"),u=document.getElementById("liaplus-action-section"),p=document.getElementById("liaplus-action-text"),g=document.getElementById("liaplus-progress-bar");s.addEventListener("click",()=>{"idle"===this.uiState.status?this.startListening():this.stopListening()}),o.addEventListener("click",()=>{this.stopListening(),this.updateUI({status:"idle"})}),this.ui={pillBtn:s,overlay:a,statusIndicator:r,statusText:l,transcriptText:c,responseSection:d,responseText:h,actionSection:u,actionText:p,progressBar:g},console.log("[LiaPlus] Modern pill UI created")}updateUI(e={}){if(this.uiState={...this.uiState,...e},!this.ui)return;const{status:t,transcript:n,response:i,action:s}=this.uiState;"idle"===t?(this.ui.overlay.classList.remove("open"),this.ui.pillBtn.textContent="ðŸŽ¤ Voice"):(this.ui.overlay.classList.add("open"),this.ui.pillBtn.innerHTML='\n          <svg viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">\n            <rect x="6" y="6" width="12" height="12" fill="currentColor" rx="2"/>\n          </svg>\n          <span>Stop</span>\n        '),this.ui.statusIndicator.className="liaplus-status-indicator","listening"===t?this.ui.statusIndicator.classList.add("listening"):"processing"===t||"executing"===t?this.ui.statusIndicator.classList.add("processing"):"completed"===t&&this.ui.statusIndicator.classList.add("completed");this.ui.statusText.textContent={idle:"Idle",listening:"Listening...",processing:"Processing",responding:"Responding",executing:"Executing",completed:"Done"}[t]||"Ready",n?(this.ui.transcriptText.textContent=`"${n}"`,this.ui.transcriptText.classList.add("active")):(this.ui.transcriptText.textContent='Say a command like "Read page" or "Scroll down"',this.ui.transcriptText.classList.remove("active")),i?(this.ui.responseText.textContent=i,this.ui.responseSection.classList.add("show")):this.ui.responseSection.classList.remove("show"),s?(this.ui.actionText.textContent=s.replace(/_/g," "),this.ui.actionSection.classList.add("show")):this.ui.actionSection.classList.remove("show"),"processing"===t||"executing"===t?this.ui.progressBar.classList.add("show"):this.ui.progressBar.classList.remove("show")}detectFollowUp(e){const t=e.toLowerCase().trim().replace(/[?.!]$/g,"").replace(/^(can you|could you|please|would you)\s+/i,"");if(t.match(/^(stop|wait|pause|shut up|quiet|silence|enough|ok stop|okay stop)/))return{type:"interrupt",action:"stop_reading"};if(t.match(/^(more|again|repeat|continue|keep going|do it again|one more|another)/)&&this.lastAction)return{type:"repeat",action:this.lastAction,parameters:this.lastParameters};if(t.match(/^(faster|speed up|quicker)/)&&this.reader&&this.reader.isReading)return{type:"modify",action:"read_faster"};if(t.match(/^(slower|slow down)/)&&this.reader&&this.reader.isReading)return{type:"modify",action:"read_slower"};if(t.match(/^(next|next one|go next)/)&&this.lastAction){if("go_to_heading"===this.lastAction||"next_heading"===this.lastAction)return{type:"relative",action:"next_heading"};if("click_link"===this.lastAction||"next_link"===this.lastAction)return{type:"relative",action:"next_link"}}if(t.match(/^(previous|go back|last one)/)&&this.lastAction){if("go_to_heading"===this.lastAction||"previous_heading"===this.lastAction)return{type:"relative",action:"previous_heading"};if("click_link"===this.lastAction||"previous_link"===this.lastAction)return{type:"relative",action:"previous_link"}}return t.match(/^(read that|read this|read it|tell me more|what does it say)/)&&"navigation"===this.lastContext?{type:"contextual",action:"read_page"}:null}processLocally(e){const t=e.toLowerCase().trim().replace(/^(can you|could you|please|would you|will you|i want to|let me|can i)\s+/i,"").replace(/[?.!]$/g,"").trim(),n="hi-IN"===this.options.language,i=t.match(/^(go to|navigate to|show me|open|find|take me to)\s+(.+)$/i);if(i)return{action:"go_to_heading",parameters:{text:i[2].trim()},response:n?`${i[2]} à¤ªà¤° à¤œà¤¾ à¤°à¤¹à¥‡ à¤¹à¥ˆà¤‚`:`Sure, taking you to ${i[2]}`,context:"navigation",canRepeat:!1};const s=t.match(/^(click|click on|press|select|tap)\s+(.+)$/i);return s?{action:"click_link",parameters:{text:s[2].trim()},response:n?`${s[2]} à¤ªà¤° click à¤•à¤° à¤°à¤¹à¥‡ à¤¹à¥ˆà¤‚`:`Clicking on ${s[2]}`,context:"navigation",canRepeat:!1}:t.match(/^(read|read page|read this|read content|read everything|read the page|start reading)/)?{action:"read_page",response:n?"à¤ªà¥‡à¤œ à¤ªà¤¢à¤¼ à¤°à¤¹à¥‡ à¤¹à¥ˆà¤‚":"Alright, reading the page for you",context:"reading",canRepeat:!0}:t.match(/^(read next|next paragraph|continue reading|next section|keep reading)/)?{action:"read_next",response:n?"à¤…à¤—à¤²à¤¾ section":"Reading next section",context:"reading",canRepeat:!0}:t.match(/^(read previous|previous paragraph|previous section|go back reading)/)?{action:"read_previous",response:n?"à¤ªà¤¿à¤›à¤²à¤¾ section":"Going back to previous section",context:"reading",canRepeat:!0}:t.match(/^(stop|stop reading|pause|silence|shut up|quiet|enough)/)?{action:"stop_reading",response:n?"à¤°à¥à¤• à¤—à¤¯à¤¾":"Stopped",context:null,canRepeat:!1}:t.match(/^(read faster|speed up|faster|quicker)/)?{action:"read_faster",response:n?"à¤¤à¥‡à¤œà¤¼ à¤ªà¤¢à¤¼ à¤°à¤¹à¥‡ à¤¹à¥ˆà¤‚":"Reading faster now",context:"reading",canRepeat:!0}:t.match(/^(read slower|slow down|slower)/)?{action:"read_slower",response:n?"à¤§à¥€à¤°à¥‡ à¤ªà¤¢à¤¼ à¤°à¤¹à¥‡ à¤¹à¥ˆà¤‚":"Slowing down",context:"reading",canRepeat:!0}:t.match(/^(list headings|show headings|what are the headings|headings|sections|show sections)/)?{action:"list_headings",response:"",context:"structure",canRepeat:!1}:t.match(/^(next heading|next section|go to next heading)/)?{action:"next_heading",response:n?"à¤…à¤—à¤²à¥€ heading":"Next heading",context:"navigation",canRepeat:!0}:t.match(/^(previous heading|last heading|previous section|go to previous heading)/)?{action:"previous_heading",response:n?"à¤ªà¤¿à¤›à¤²à¥€ heading":"Previous heading",context:"navigation",canRepeat:!0}:t.match(/^(list links|show links|what are the links|links|show all links)/)?{action:"list_links",response:"",context:"structure",canRepeat:!1}:t.match(/^(next link|go to next link)/)?{action:"next_link",response:n?"à¤…à¤—à¤²à¥€ link":"Next link",context:"navigation",canRepeat:!0}:t.match(/^(previous link|last link|go to previous link)/)?{action:"previous_link",response:n?"à¤ªà¤¿à¤›à¤²à¥€ link":"Previous link",context:"navigation",canRepeat:!0}:t.match(/^(describe page|page summary|what's on this page|summarize|what is this page)/)?{action:"describe_page",response:"",context:"information",canRepeat:!1}:t.match(/^(scroll down|go down|page down|down|move down)/)?{action:"scroll_down",response:n?"à¤¨à¥€à¤šà¥‡ scroll":"Scrolling down",context:"scrolling",canRepeat:!0}:t.match(/^(scroll up|go up|page up|up|move up)/)?{action:"scroll_up",response:n?"à¤Šà¤ªà¤° scroll":"Scrolling up",context:"scrolling",canRepeat:!0}:t.match(/^(scroll more|more scrolling|keep scrolling)/)&&this.lastAction&&("scroll_down"===this.lastAction||"scroll_up"===this.lastAction)?{action:this.lastAction,response:n?"à¤”à¤° scroll":"Scrolling more",context:"scrolling",canRepeat:!0}:t.match(/^(top|go to top|scroll to top|home|start|beginning)/)?{action:"scroll_to_top",response:n?"à¤¸à¤¬à¤¸à¥‡ à¤Šà¤ªà¤°":"Going to top",context:"scrolling",canRepeat:!1}:t.match(/^(bottom|go to bottom|scroll to bottom|end)/)?{action:"scroll_to_bottom",response:n?"à¤¸à¤¬à¤¸à¥‡ à¤¨à¥€à¤šà¥‡":"Going to bottom",context:"scrolling",canRepeat:!1}:t.match(/^(dyslexia font|dyslexia mode|readable font|easy font)/)?{action:"toggle_dyslexia_font",response:n?"Dyslexia font toggle à¤•à¤¿à¤¯à¤¾":"Toggling dyslexia-friendly font",context:"accessibility",canRepeat:!0}:t.match(/^(adhd mode|focus mode|reading bar|spotlight|focus)/)?{action:"toggle_adhd_mode",response:n?"Focus mode toggle à¤•à¤¿à¤¯à¤¾":"Toggling focus mode",context:"accessibility",canRepeat:!0}:t.match(/^(big cursor|large cursor|bigger cursor)/)?{action:"toggle_big_cursor",response:n?"Big cursor toggle à¤•à¤¿à¤¯à¤¾":"Toggling big cursor",context:"accessibility",canRepeat:!0}:t.match(/^(zoom in|bigger|larger|increase size|make bigger)/)?{action:"zoom_in",response:n?"Zoom in":"Zooming in",context:"accessibility",canRepeat:!0}:t.match(/^(zoom out|smaller|decrease size|make smaller)/)?{action:"zoom_out",response:n?"Zoom out":"Zooming out",context:"accessibility",canRepeat:!0}:t.match(/^(highlight links|show links visually)/)?{action:"highlight_links",response:n?"Links highlight à¤•à¤¿à¤¯à¤¾":"Highlighting links",context:"accessibility",canRepeat:!0}:t.match(/^(tab|next element|next field|next button)/)?{action:"tab",response:n?"à¤…à¤—à¤²à¤¾ element":"Next element",context:"navigation",canRepeat:!0}:t.match(/^(enter|activate|submit|press enter)/)?{action:"enter",response:n?"Enter":"Activating",context:"navigation",canRepeat:!1}:t.match(/^(back|go back|previous page|navigate back)/)?{action:"back",response:n?"à¤ªà¥€à¤›à¥‡ à¤œà¤¾ à¤°à¤¹à¥‡ à¤¹à¥ˆà¤‚":"Going back",context:"navigation",canRepeat:!1}:t.match(/^(where am i|current page|what page|which page)/)?{action:"where_am_i",response:`You are on ${document.title}`,context:"information",canRepeat:!1}:t.match(/^(help|commands|show commands|what can you do|what can i say)/)?{action:"show_commands",response:n?"Commands à¤¦à¤¿à¤–à¤¾ à¤°à¤¹à¥‡ à¤¹à¥ˆà¤‚":"Here are the available commands",context:"help",canRepeat:!1}:t.match(/^(list forms|show forms|what forms|forms on page)/)?{action:"list_forms",response:"",context:"forms",canRepeat:!1}:t.match(/^(fill form|complete form|auto fill)/)?{action:"fill_form",response:n?"Form à¤­à¤° à¤°à¤¹à¥‡ à¤¹à¥ˆà¤‚":"Filling form with provided information",context:"forms",canRepeat:!1}:t.match(/^(submit form|send form|submit)/)?{action:"submit_form",response:n?"Form submit à¤•à¤° à¤°à¤¹à¥‡ à¤¹à¥ˆà¤‚":"Submitting form",context:"forms",canRepeat:!1}:{action:"chat",response:null,context:null,canRepeat:!1}}async processCommand(e){try{console.log("[LiaPlus] Processing command:",e),this.reader&&this.reader.isSpeaking&&(this.reader.interruptSpeech(),await new Promise(e=>setTimeout(e,100)));const t=this.detectFollowUp(e);if(t)return console.log("[LiaPlus] Follow-up detected:",t),await this.executeFollowUp(t);this.conversationHistory.push({role:"user",content:e,timestamp:Date.now()}),this.conversationHistory.length>10&&(this.conversationHistory=this.conversationHistory.slice(-10));let n=null;try{console.log("[LiaPlus] Attempting API processing..."),n=await this.processWithAPI(e),console.log("[LiaPlus] API processing succeeded:",n)}catch(e){console.warn("[LiaPlus] API failed, using local processing:",e.message),console.error("[LiaPlus] Full API error:",e)}if(!n||"chat"===n.action){console.log("[LiaPlus] Using local processing...");const t=this.processLocally(e);console.log("[LiaPlus] Local processing result:",t),"chat"!==t.action?n=t:n||(n=t)}return this.updateUI({status:"processing",transcript:e}),n.action&&"chat"!==n.action&&(this.updateUI({status:"executing",response:n.response,action:n.action}),await this.executor.execute(n.action,n.parameters),this.lastAction=n.action,this.lastParameters=n.parameters||{},n.context&&(this.lastContext=n.context),this.updateUI({status:"completed"})),n.response&&await this.reader.speak(n.response),setTimeout(()=>{"completed"===this.uiState.status&&this.updateUI({status:"idle",transcript:"",response:"",action:null})},2e3),this.conversationHistory.push({role:"assistant",content:n.response||n.action,timestamp:Date.now()}),this.options.onCommand&&this.options.onCommand(n),n}catch(e){console.error("[LiaPlus] Command processing failed:",e),this.options.onError&&this.options.onError(e);const t="hi-IN"===this.options.language?"à¤®à¤¾à¤«à¤¼ à¤•à¤°à¥‡à¤‚, à¤•à¥à¤› à¤—à¤¡à¤¼à¤¬à¤¡à¤¼ à¤¹à¥‹ à¤—à¤ˆà¥¤ à¤•à¥ƒà¤ªà¤¯à¤¾ à¤«à¤¿à¤° à¤¸à¥‡ à¤•à¥‹à¤¶à¤¿à¤¶ à¤•à¤°à¥‡à¤‚à¥¤":"Sorry, something went wrong. Please try again.";throw await this.reader.speak(t),e}}async executeFollowUp(e){let t;const n="hi-IN"===this.options.language;switch(e.type){case"interrupt":this.reader.stop(),t={action:"stop_reading",response:n?"à¤°à¥à¤• à¤—à¤¯à¤¾":"Stopped"};break;case"repeat":t={action:e.action,parameters:e.parameters,response:n?"à¤«à¤¿à¤° à¤¸à¥‡ à¤•à¤° à¤°à¤¹à¥‡ à¤¹à¥ˆà¤‚":"Doing it again",canRepeat:!0};break;case"modify":t={action:e.action,response:"read_faster"===e.action?n?"à¤¤à¥‡à¤œà¤¼":"Faster":n?"à¤§à¥€à¤°à¥‡":"Slower"};break;case"relative":t={action:e.action,response:e.action.includes("next")?n?"à¤…à¤—à¤²à¤¾":"Next one":n?"à¤ªà¤¿à¤›à¤²à¤¾":"Previous one",canRepeat:!0};break;case"contextual":t={action:e.action,response:n?"à¤ªà¤¢à¤¼ à¤°à¤¹à¥‡ à¤¹à¥ˆà¤‚":"Reading it for you"};break;default:t=this.processLocally(e.action)}return t.action&&"chat"!==t.action&&(await this.executor.execute(t.action,t.parameters),this.lastAction=t.action,this.lastParameters=t.parameters||{}),t.response&&await this.reader.speak(t.response),t}async processWithAPI(t){const i=this.parser.parse(),s=this.parser.getPageContent(),a=t.toLowerCase().match(/fill|form|enter|my name is|email|phone|address/);console.log("[LiaPlus] API Request:",{command:t,isFormCommand:a,formsCount:i.forms.length,hasFormFields:i.forms.length>0?i.forms[0].fields.length:0});const o={command:t,language:this.options.language,pageContent:s.slice(0,2e3),pageStructure:{headings:i.headings.map(e=>({level:e.level,text:e.text,id:e.id})),landmarks:i.landmarks.map(e=>({role:e.role,label:e.label})),links:i.links.slice(0,20).map(e=>({text:e.text,href:e.href})),forms:i.forms.length>0?i.forms.map(e=>({id:e.id,fields:e.fields.map(e=>({name:e.name,label:e.label,type:e.type,required:e.required}))})):[]},currentUrl:e.location.href,conversationHistory:this.conversationHistory.slice(-5),lastAction:this.lastAction,lastContext:this.lastContext,extractFormData:a};console.log("[LiaPlus] Sending to API:",o);const r=await fetch(`${n}/voice-plugin`,{method:"POST",headers:{"Content-Type":"application/json",...this.options.apiKey&&{"X-API-Key":this.options.apiKey}},body:JSON.stringify(o)});if(console.log("[LiaPlus] API Response Status:",r.status,r.statusText),!r.ok){const e=await r.text();throw console.error("[LiaPlus] API Error Response:",e),new Error(`API error: ${r.status} - ${e}`)}const l=await r.json();return console.log("[LiaPlus] API Response Data:",l),l}setLanguage(e){this.options.language=e,this.reader&&this.reader.setLanguage(e),this.saveState()}startListening(){this.recognizer?(this.isListening=!0,this.updateUI({status:"listening"}),this.recognizer.startContinuousRecognitionAsync(()=>{console.log("[LiaPlus] Started listening")},e=>{console.error("[LiaPlus] Failed to start listening:",e),this.isListening=!1,this.updateUI({status:"idle"})}),this.recognizer.recognizing=(e,t)=>{if(t.result.reason===SpeechSDK.ResultReason.RecognizingSpeech){const e=t.result.text;console.log("[LiaPlus] Interim:",e),this.updateUI({transcript:e})}},this.recognizer.recognized=async(e,t)=>{if(t.result.reason===SpeechSDK.ResultReason.RecognizedSpeech){const e=t.result.text;console.log("[LiaPlus] Command:",e),await this.processCommand(e)}}):console.error("[LiaPlus] Recognizer not initialized")}stopListening(){this.recognizer&&(this.isListening=!1,this.updateUI({status:"idle",transcript:"",response:"",action:null}),this.recognizer.stopContinuousRecognitionAsync(()=>{console.log("[LiaPlus] Stopped listening")},e=>{console.error("[LiaPlus] Failed to stop listening:",e)}))}saveState(){try{localStorage.setItem("liaplus-voice-state",JSON.stringify({language:this.options.language,isListening:this.isListening,lastContext:this.lastContext}))}catch(e){console.warn("[LiaPlus] Failed to save state:",e)}}loadState(){try{const e=localStorage.getItem("liaplus-voice-state");if(e){const t=JSON.parse(e);t.language&&this.setLanguage(t.language),t.isListening&&this.startListening(),this.lastContext=t.lastContext}}catch(e){console.warn("[LiaPlus] Failed to load state:",e)}}destroy(){this.stopListening(),this.recognizer&&this.recognizer.close(),this.synthesizer&&this.synthesizer.close(),this.isInitialized=!1}}e.LiaPlusVoice={VERSION:t,init:e=>{const t=new o(e);return t.init(),t},PageParser:i,ContentReader:s,ActionExecutor:a,VoiceNavigationPlugin:o},console.log(`[LiaPlus] Voice Navigation Plugin ${t} loaded`)}(window);